<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Astro Escape Pro</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root { --tg-theme-bg-color: #0b0e14; --tg-theme-text-color: #ffffff; }
        body { display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; background-color: var(--tg-theme-bg-color); color: var(--tg-theme-text-color); overflow: hidden; font-family: 'Segoe UI', Tahoma, sans-serif; flex-direction: column; }
        #game-container { width: 95vw; max-width: 500px; height: 250px; background: linear-gradient(to bottom, #1a1c2c 0%, #4a192c 100%); border: 3px solid #333; position: relative; overflow: hidden; border-radius: 20px; touch-action: none; }
        #player { width: 40px; height: 40px; position: absolute; bottom: 0; left: 50px; z-index: 5; font-size: 30px; display: flex; justify-content: center; align-items: center; transition: transform 0.1s; }
        #player.crouching { transform: scaleY(0.5); }
        .obstacle { position: absolute; right: -50px; display: flex; justify-content: center; align-items: center; }
        .spike { width: 30px; height: 30px; bottom: 0; font-size: 25px; }
        .bird { width: 35px; height: 35px; bottom: 45px; font-size: 28px; }
        #score-board { margin-top: 15px; font-size: 1.8rem; font-weight: bold; }
        #start-button { padding: 15px 40px; font-size: 1.2rem; cursor: pointer; background: #2ecc71; color: white; border: none; border-radius: 50px; margin-bottom: 20px; box-shadow: 0 4px 0 #27ae60; }
        #game-over-screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); display: none; flex-direction: column; justify-content: center; align-items: center; z-index: 10; text-align: center; }
        #leaderboard-list { width: 80%; margin: 15px 0; font-size: 0.9rem; border-top: 1px solid #444; padding-top: 10px; }
        #restart-button { padding: 10px 30px; background: #f39c12; color: white; border: none; border-radius: 8px; cursor: pointer; }
    </style>
</head>
<body>

    <button id="start-button">START MISSION üöÄ</button>

    <div id="game-container">
        <div id="player">üë®‚ÄçüöÄ</div>
        <div id="game-over-screen">
            <h2 style="color:#e74c3c">MISSION FAILED</h2>
            <p id="final-score">Score: 0</p>
            <div id="leaderboard-list">Loading Rankings...</div>
            <button id="restart-button">TRY AGAIN</button>
        </div>
    </div>

    <div id="score-board">0m</div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // BURAYI DEƒûƒ∞≈ûTƒ∞R: Firebase Console'dan aldƒ±ƒüƒ±n kendi bilgilerini buraya yapƒ±≈ütƒ±r
        const firebaseConfig = {
            apiKey: "AIzaSyATyXHuTvuRTLifr0TAO9YPemITkaIWR7k",
            authDomain: "thorn-game-51a1e.firebaseapp.com",
            projectId: "thorn-game-51a1e",
            storageBucket: "thorn-game-51a1e.firebasestorage.app",
            messagingSenderId: "630511119608",
            appId: "1:630511119608:web:13299711840ffd7ca9df0d"
        };

        // Firebase ba≈ülatƒ±lƒ±yor
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Skoru Kaydetme (Global eri≈üim i√ßin window'a baƒüladƒ±k)
        window.saveScoreToDB = async (name, score) => {
            try {
                await addDoc(collection(db, "leaderboard"), {
                    name: name,
                    score: score,
                    timestamp: new Date()
                });
                window.loadLeaderboard();
            } catch (e) { console.error("Firebase Hatasƒ±:", e); }
        };

        // Sƒ±ralamayƒ± √áekme
        window.loadLeaderboard = async () => {
            const q = query(collection(db, "leaderboard"), orderBy("score", "desc"), limit(5));
            const querySnapshot = await getDocs(q);
            let html = "<b>TOP 5 ASTRONAUTS:</b><br>";
            querySnapshot.forEach((doc) => {
                const d = doc.data();
                html += `<div>${d.name}: ${d.score}m</div>`;
            });
            document.getElementById('leaderboard-list').innerHTML = html;
        };
    </script>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        const player = document.getElementById('player');
        const gameContainer = document.getElementById('game-container');
        const scoreBoard = document.getElementById('score-board');
        const startButton = document.getElementById('start-button');
        const gameOverScreen = document.getElementById('game-over-screen');
        const finalScoreDisplay = document.getElementById('final-score');
        const restartButton = document.getElementById('restart-button');

        let isJumping = false;
        let isCrouching = false;
        let score = 0;
        let gameOver = true;
        let gameSpeed = 5;
        let gameLoop, spawnTimer;

        function startGame() {
            gameOver = false;
            score = 0;
            gameSpeed = 5;
            scoreBoard.textContent = '0m';
            player.style.bottom = '0px';
            player.innerHTML = "üë®‚ÄçüöÄ";
            gameOverScreen.style.display = 'none';
            startButton.style.display = 'none';
            document.querySelectorAll('.obstacle').forEach(o => o.remove());
            
            gameLoop = setInterval(() => {
                score++;
                scoreBoard.textContent = score + 'm';
                if(score % 500 === 0) gameSpeed += 0.5;
            }, 20);
            spawn();
        }

        function jump() {
            if (isJumping || isCrouching || gameOver) return;
            isJumping = true;
            let pos = 0;
            let up = setInterval(() => {
                if (pos >= 110) {
                    clearInterval(up);
                    let down = setInterval(() => {
                        if (pos <= 0) { clearInterval(down); isJumping = false; }
                        pos -= 6;
                        player.style.bottom = Math.max(0, pos) + 'px';
                    }, 20);
                }
                pos += 6;
                player.style.bottom = pos + 'px';
            }, 20);
        }

        function crouch(state) {
            if (isJumping || gameOver) return;
            isCrouching = state;
            state ? player.classList.add('crouching') : player.classList.remove('crouching');
        }

        function spawn() {
            if (gameOver) return;
            const obs = document.createElement('div');
            const isBird = Math.random() > 0.6;
            obs.className = 'obstacle ' + (isBird ? 'bird' : 'spike');
            obs.innerHTML = isBird ? "üõ∏" : "üåµ";
            gameContainer.appendChild(obs);

            let x = -50;
            let move = setInterval(() => {
                if (gameOver) return clearInterval(move);
                x += gameSpeed;
                obs.style.right = x + 'px';

                const p = player.getBoundingClientRect();
                const o = obs.getBoundingClientRect();
                const tol = 8; 

                if (p.left + tol < o.right && p.right - tol > o.left && 
                    p.bottom - tol > o.top && p.top + tol < o.bottom) {
                    die();
                    clearInterval(move);
                }
                if (x > 600) { obs.remove(); clearInterval(move); }
            }, 20);

            spawnTimer = setTimeout(spawn, Math.max(Math.random() * 1000 + 700 - (score/30), 500));
        }

        function die() {
            gameOver = true;
            clearInterval(gameLoop);
            clearTimeout(spawnTimer);
            player.innerHTML = "üí•";
            finalScoreDisplay.textContent = 'Distance: ' + score + 'm';
            gameOverScreen.style.display = 'flex';
            
            const name = tg.initDataUnsafe?.user?.first_name || "Astronaut";
            if(window.saveScoreToDB) window.saveScoreToDB(name, score);
            if(tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('error');
        }

        window.onkeydown = e => {
            if(e.code === 'Space' || e.code === 'ArrowUp') jump();
            if(e.code === 'ArrowDown') crouch(true);
        };
        window.onkeyup = e => { if(e.code === 'ArrowDown') crouch(false); };

        gameContainer.ontouchstart = e => {
            e.preventDefault();
            const y = e.touches[0].clientY - gameContainer.getBoundingClientRect().top;
            y < 125 ? jump() : crouch(true);
        };
        gameContainer.ontouchend = () => crouch(false);

        startButton.onclick = startGame;
        restartButton.onclick = startGame;
    </script>
</body>
</html>
